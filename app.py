import streamlit as st
from streamlit_gsheets import GSheetsConnection
import pandas as pd
from datetime import datetime, timedelta
import pytz
import random
import os
from fpdf import FPDF

# --- 1. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÅ‡∏•‡∏∞‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢ ---
st.set_page_config(page_title="‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≤‡∏£‡∏ß‡∏±‡∏ï‡∏£‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô", page_icon="üëÆ‚Äç‚ôÇÔ∏è", layout="wide")

def get_now_th():
    return datetime.now(pytz.timezone('Asia/Bangkok'))

# ‡∏ã‡πà‡∏≠‡∏ô UI ‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏∑‡∏≠‡∏≠‡∏≤‡∏ä‡∏µ‡∏û
st.markdown("""
    <style>
    #MainMenu {visibility: hidden;} header {visibility: hidden;} footer {visibility: hidden;}
    .stDeployButton {display:none;} [data-testid="stSidebar"] {display: none;}
    .main-header { font-size: 26px; font-weight: bold; color: #1E3A8A; }
    .report-id-box { background-color: #f0f9ff; border: 2px solid #1E3A8A; padding: 20px; border-radius: 10px; text-align: center; margin: 20px 0; }
    </style>
""", unsafe_allow_html=True)

# ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Google Sheets
conn = st.connection("gsheets", type=GSheetsConnection)

# --- 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô NaN) ---
def clean_val(val):
    if pd.isna(val) or str(val).lower() == "nan":
        return ""
    return str(val)

# --- üîë 3. ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÅ‡∏•‡∏∞ Session Timeout (30 ‡∏ô‡∏≤‡∏ó‡∏µ) ---
OFFICER_ACCOUNTS = {
    "Patwit1510": {"name": "‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î", "role": "admin"},
    "Pencharee001": {"name": "‡∏Ñ‡∏£‡∏π‡πÄ‡∏û‡πá‡∏ç‡∏ä‡∏£‡∏µ‡∏¢‡πå (‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á)", "role": "admin"},
    "Chaiya001": {"name": "‡∏Ñ‡∏£‡∏π‡πÑ‡∏ä‡∏¢‡∏≤(‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á)", "role": "admin"},
    "Jak001": {"name": "‡∏¢‡∏≤‡∏°‡∏à‡∏±‡∏Å‡∏£ (‡∏£‡∏õ‡∏†.)", "role": "admin"},
    "User01": {"name": "‡∏ú‡∏π‡πâ‡∏Å‡∏≥‡∏Å‡∏±‡∏ö(‡∏ï‡∏≥‡∏£‡∏ß‡∏à‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô)", "role": "admin"},
    "User02": {"name": "‡∏£‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏à‡∏£‡∏≤‡∏à‡∏£(‡∏ï‡∏≥‡∏£‡∏ß‡∏à‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô)", "role": "admin"},
    "User03": {"name": "‡∏Ñ‡∏£‡∏π‡πÄ‡∏ß‡∏£ (‡∏ï‡∏£‡∏ß‡∏à‡∏Å‡∏≤‡∏£‡∏ì‡πå)", "role": "viewer"},
    "User04": {"name": "‡∏ï‡∏≥‡∏£‡∏ß‡∏à‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô", "role": "viewer"}
}

if 'current_user' not in st.session_state:
    st.session_state.current_user = None
if 'last_activity' not in st.session_state:
    st.session_state.last_activity = get_now_th()

# ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡∏∞ Timeout 30 ‡∏ô‡∏≤‡∏ó‡∏µ
if st.session_state.current_user:
    elapsed = (get_now_th() - st.session_state.last_activity).total_seconds()
    if elapsed > 1800: # 30 ‡∏ô‡∏≤‡∏ó‡∏µ
        st.session_state.current_user = None
        st.rerun()
    else:
        st.session_state.last_activity = get_now_th()

# --- üìÑ 4. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á PDF (‡πÅ‡∏ö‡∏ö‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£ + ‡πÇ‡∏•‡πÇ‡∏Å‡πâ) ---
def create_pdf(row_data):
    try:
        pdf = FPDF()
        pdf.set_margins(15, 15, 15)
        pdf.add_page()
        font_p = "THSarabunNew.ttf"
        logo_p = "school_logo.png"
        
        if not os.path.exists(font_p): return "MISSING_FONT"
        pdf.add_font('ThaiFont', '', font_p)
        
        # ‡πÉ‡∏™‡πà‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á)
        if os.path.exists(logo_p): pdf.image(logo_p, x=15, y=12, w=18)
        
        pdf.set_y(15)
        pdf.set_font('ThaiFont', '', 20)
        pdf.cell(0, 10, txt="‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ‡∏ï‡∏≥‡∏£‡∏ß‡∏à‡∏†‡∏π‡∏ò‡∏£‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÇ‡∏û‡∏ô‡∏ó‡∏≠‡∏á‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤", ln=True, align='C')
        pdf.set_font('ThaiFont', '', 16)
        pdf.cell(0, 10, txt="‡πÉ‡∏ö‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÅ‡∏•‡∏∞‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö‡∏™‡∏ß‡∏ô", ln=True, align='C')
        pdf.ln(5)
        pdf.line(15, pdf.get_y(), 195, pdf.get_y())
        pdf.ln(8)

        # ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô
        pdf.set_font('ThaiFont', '', 14)
        pdf.cell(90, 8, txt=f"‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡πÅ‡∏à‡πâ‡∏á: {row_data.get('Report_ID', '-')}")
        pdf.cell(90, 8, txt=f"‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏: {row_data.get('Timestamp', '-')}", align='R', ln=True)
        pdf.multi_cell(0, 8, txt=f"‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏´‡∏ï‡∏∏: {row_data.get('Incident_Type', '-')} | ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà: {row_data.get('Location', '-')}")
        
        pdf.ln(5)
        pdf.set_font('ThaiFont', '', 15)
        pdf.cell(0, 8, txt="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö‡∏™‡∏ß‡∏ô:", ln=True)
        pdf.set_font('ThaiFont', '', 14)
        
        invest_info = [
            f"‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢: {clean_val(row_data.get('Victim'))}",
            f"‡∏ú‡∏π‡πâ‡∏ñ‡∏π‡∏Å‡∏Å‡∏•‡πà‡∏≤‡∏ß‡∏´‡∏≤: {clean_val(row_data.get('Accused'))}",
            f"‡∏û‡∏¢‡∏≤‡∏ô: {clean_val(row_data.get('Witness'))}",
            f"‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ö‡∏™‡∏ß‡∏ô: {clean_val(row_data.get('Teacher_Investigator'))}",
            f"‡∏ï‡∏≥‡∏£‡∏ß‡∏à‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô: {clean_val(row_data.get('Student_Police_Investigator'))}",
            f"‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: {row_data.get('Status', '-')}"
        ]
        for line in invest_info: pdf.cell(0, 8, txt=line, ln=True)
        
        pdf.ln(3)
        pdf.multi_cell(0, 8, txt=f"‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡πÉ‡∏´‡πâ‡∏Å‡∏≤‡∏£/‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£: {clean_val(row_data.get('Statement'))}", border=1)
        
        # ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏á‡∏ô‡∏≤‡∏°
        pdf.set_y(-50)
        pdf.cell(85, 7, txt="‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠.........................................", align='C')
        pdf.cell(85, 7, txt="‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠.........................................", ln=True, align='C')
        pdf.cell(85, 7, txt=f"( {row_data.get('Handled_By', '......................')} )", align='C')
        pdf.cell(85, 7, txt="(.........................................)", ln=True, align='C')
        pdf.cell(85, 7, txt="‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£", align='C')
        pdf.cell(85, 7, txt="‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á/‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤", ln=True, align='C')

        return pdf.output()
    except Exception as e: return str(e)

# --- üìã 5. ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà ---
def officer_dashboard():
    user = st.session_state.current_user
    logo_p = "school_logo.png"
    
    if os.path.exists(logo_p):
        c1, c2, c3 = st.columns([5, 1, 5])
        with c2: st.image(logo_p, width=80)

    col_h1, col_h2 = st.columns([4, 1])
    with col_h1: st.markdown(f"<div class='main-header'>üè¢ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ (‡∏Ñ‡∏∏‡∏ì{user['name']})</div>", unsafe_allow_html=True)
    with col_h2: 
        if st.button("üî¥ Logout", use_container_width=True):
            st.session_state.current_user = None
            st.rerun()

    try:
        df = conn.read(ttl=0)
        tab1, tab2 = st.tabs(["üîé ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î", "üõ† ‡∏™‡∏≠‡∏ö‡∏™‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•"])
        
        with tab1: st.dataframe(df.iloc[::-1], use_container_width=True)

        with tab2:
            if user['role'] == 'admin':
                ids = df['Report_ID'].dropna().unique().tolist()
                sid = st.selectbox("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡πÅ‡∏à‡πâ‡∏á", ids)
                sel = df[df['Report_ID'] == sid]
                if not sel.empty:
                    idx = sel.index[0]
                    row = sel.iloc[0]
                    with st.container(border=True):
                        st.write(f"üìù **‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏î‡∏¥‡∏°:** {row['Details']}")
                        c1, c2 = st.columns(2)
                        with c1:
                            v_vic = st.text_input("‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢", value=clean_val(row.get('Victim')), placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠...")
                            v_acc = st.text_input("‡∏ú‡∏π‡πâ‡∏ñ‡∏π‡∏Å‡∏Å‡∏•‡πà‡∏≤‡∏ß‡∏´‡∏≤", value=clean_val(row.get('Accused')), placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠...")
                            v_wit = st.text_input("‡∏û‡∏¢‡∏≤‡∏ô", value=clean_val(row.get('Witness')), placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠...")
                        with c2:
                            v_tea = st.text_input("‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ö‡∏™‡∏ß‡∏ô", value=clean_val(row.get('Teacher_Investigator')), placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠...")
                            v_stu = st.text_input("‡∏ï‡∏≥‡∏£‡∏ß‡∏à‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏≠‡∏ö‡∏™‡∏ß‡∏ô", value=clean_val(row.get('Student_Police_Investigator')), placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠...")
                            v_sta = st.selectbox("‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞", ["‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£", "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£", "‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß", "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å"], index=0)
                        
                        v_stmt = st.text_area("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡πÉ‡∏´‡πâ‡∏Å‡∏≤‡∏£", value=clean_val(row.get('Statement')), placeholder="‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà...")

                        if st.button("üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö‡∏™‡∏ß‡∏ô", type="primary", use_container_width=True):
                            df.at[idx, 'Victim'], df.at[idx, 'Accused'], df.at[idx, 'Witness'] = v_vic, v_acc, v_wit
                            df.at[idx, 'Teacher_Investigator'], df.at[idx, 'Student_Police_Investigator'] = v_tea, v_stu
                            df.at[idx, 'Status'], df.at[idx, 'Statement'], df.at[idx, 'Handled_By'] = v_sta, v_stmt, user['name']
                            conn.update(data=df)
                            st.success("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!")
                            st.rerun()
                        
                        pdf_bytes = create_pdf(df.loc[idx])
                        if isinstance(pdf_bytes, (bytes, bytearray)):
                            st.download_button("üì• ‡∏û‡∏¥‡∏°‡∏û‡πå PDF ‡πÉ‡∏ö‡∏™‡∏≠‡∏ö‡∏™‡∏ß‡∏ô", data=bytes(pdf_bytes), file_name=f"Report_{sid}.pdf", mime="application/pdf", use_container_width=True)
            else: st.warning("üîí ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡∏π‡∏á‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ")
    except Exception as e: st.error(f"Error: {e}")

# --- üìù 6. ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏´‡∏•‡∏±‡∏Å‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô ---
def main_page():
    logo_p = "school_logo.png"
    if os.path.exists(logo_p):
        c1, c2, c3 = st.columns([5, 1, 5])
        with c2: st.image(logo_p, width=100)

    st.markdown("<h1 style='text-align: center; color: #1E3A8A;'>üëÆ‚Äç‚ôÇÔ∏è ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡∏™‡∏≤‡∏£‡∏ß‡∏±‡∏ï‡∏£‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h1>", unsafe_allow_html=True)
    st.markdown("<p style='text-align: center;'>‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÇ‡∏û‡∏ô‡∏ó‡∏≠‡∏á‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤</p>", unsafe_allow_html=True)
    
    if st.session_state.submitted_id:
        st.markdown(f"<div class='report-id-box'><h2>‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</h2><p>‡πÄ‡∏•‡∏Ç‡∏£‡∏±‡∏ö‡πÅ‡∏à‡πâ‡∏á: <b>{st.session_state.submitted_id}</b></p></div>", unsafe_allow_html=True)
        if st.button("‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà"):
            st.session_state.submitted_id = None
            st.rerun()
    else:
        with st.container(border=True):
            with st.form("report"):
                c1, c2 = st.columns(2)
                with c1:
                    rep = st.text_input("‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á")
                    typ = st.selectbox("‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏´‡∏ï‡∏∏", ["‡∏ó‡∏∞‡πÄ‡∏•‡∏≤‡∏∞‡∏ß‡∏¥‡∏ß‡∏≤‡∏ó", "‡∏™‡∏≤‡∏£‡πÄ‡∏™‡∏û‡∏ï‡∏¥‡∏î", "‡∏ä‡∏π‡πâ‡∏™‡∏≤‡∏ß", "‡∏´‡∏ô‡∏µ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô", "‡∏≠‡∏∑‡πà‡∏ô‡πÜ"])
                with c2: loc = st.text_input("‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡πÄ‡∏´‡∏ï‡∏∏ *")
                det = st.text_area("‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå *")
                if st.form_submit_button("üì§ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏", use_container_width=True):
                    if loc and det:
                        rid = f"POL-{get_now_th().strftime('%Y%m%d')}-{random.randint(1000, 9999)}"
                        df_old = conn.read(ttl=0)
                        new_r = pd.DataFrame([{"Timestamp": get_now_th().strftime("%d/%m/%Y %H:%M:%S"), "Reporter": rep, "Incident_Type": typ, "Location": loc, "Details": det, "Status": "‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£", "Report_ID": rid}])
                        conn.update(data=pd.concat([df_old, new_r], ignore_index=True))
                        st.session_state.submitted_id = rid
                        st.rerun()
                    else: st.error("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö")

    st.markdown("---")
    with st.expander("üîê ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà"):
        pw = st.text_input("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô", type="password")
        if st.button("Login"):
            if pw in OFFICER_ACCOUNTS:
                st.session_state.current_user = OFFICER_ACCOUNTS[pw]
                st.session_state.last_activity = get_now_th()
                st.rerun()
            else: st.error("‚ùå ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á")

# --- üöÄ 7. ‡∏£‡∏±‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ---
if st.session_state.current_user:
    officer_dashboard()
else:
    main_page()
