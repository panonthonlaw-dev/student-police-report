import streamlit as st
from streamlit_gsheets import GSheetsConnection
import pandas as pd
from datetime import datetime
import pytz
import random
import os
import base64
import io
import qrcode
import glob
from weasyprint import HTML, CSS
from weasyprint.text.fonts import FontConfiguration

# --- 1. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ ---
st.set_page_config(page_title="‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ‡∏ï‡∏≥‡∏£‡∏ß‡∏à‡∏†‡∏π‡∏ò‡∏£‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÇ‡∏û‡∏ô‡∏ó‡∏≠‡∏á‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤", page_icon="üëÆ‚Äç‚ôÇÔ∏è", layout="wide")

# --- ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÑ‡∏ü‡∏•‡πå ---
BASE_DIR = os.path.dirname(os.path.abspath(__file__))
FONT_FILE = os.path.join(BASE_DIR, "THSarabunNew.ttf")

# ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏£‡∏π‡∏õ‡πÄ‡∏õ‡πá‡∏ô Base64 (‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡πÑ‡∏°‡πà‡∏Ç‡∏∂‡πâ‡∏ô 100%)
def get_base64_image(image_path):
    if not image_path or not os.path.exists(image_path):
        return ""
    with open(image_path, "rb") as img_file:
        return base64.b64encode(img_file.read()).decode('utf-8')

# ‡∏´‡∏≤‡πÑ‡∏ü‡∏•‡πå‡πÇ‡∏•‡πÇ‡∏Å‡πâ
LOGO_PATH = None
possible_logos = glob.glob(os.path.join(BASE_DIR, "school_logo*"))
for f in possible_logos:
    if f.lower().endswith(('.png', '.jpg', '.jpeg', '.bmp')):
        LOGO_PATH = f
        break

# ‡πÅ‡∏õ‡∏•‡∏á‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡∏£‡∏≠‡πÑ‡∏ß‡πâ‡πÄ‡∏•‡∏¢
LOGO_BASE64 = get_base64_image(LOGO_PATH) if LOGO_PATH else ""

# --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á PDF ‡∏î‡πâ‡∏ß‡∏¢ WeasyPrint (HTML -> PDF) ---
def create_pdf(row):
    # ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    rid = str(row.get('Report_ID', ''))
    date_str = str(row.get('Timestamp', ''))
    reporter = str(row.get('Reporter', '-'))
    incident = str(row.get('Incident_Type', '-'))
    location = str(row.get('Location', '-'))
    details = str(row.get('Details', '-'))
    statement = str(row.get('Statement', '-'))
    
    # ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Footer
    printer_name = st.session_state.current_user['name'] if st.session_state.current_user else "System"
    print_time = datetime.now(pytz.timezone('Asia/Bangkok')).strftime("%d/%m/%Y %H:%M:%S")

    # ‡∏™‡∏£‡πâ‡∏≤‡∏á QR Code
    qr = qrcode.make(rid)
    qr_buffer = io.BytesIO()
    qr.save(qr_buffer, format="PNG")
    qr_base64 = base64.b64encode(qr_buffer.getvalue()).decode()

    # ‡∏£‡∏π‡∏õ‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô
    evidence_html = ""
    if row.get('Evidence_Image'):
        evidence_html = f"""
        <div style='margin-top: 10px; page-break-inside: avoid;'>
            <b>‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö:</b><br>
            <img src="data:image/jpeg;base64,{row.get('Evidence_Image')}" style="max-height: 150px; border: 1px solid #ccc;">
        </div>
        """

    # HTML Template (‡∏à‡∏±‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô Word/Excel)
    html_content = f"""
    <!DOCTYPE html>
    <html>
    <head>
        <style>
            @font-face {{
                font-family: 'THSarabunNew';
                src: url('file://{FONT_FILE}');
            }}
            @page {{
                size: A4;
                margin: 2cm;
                @bottom-right {{
                    content: "‡∏ú‡∏π‡πâ‡∏û‡∏¥‡∏°‡∏û‡πå: {printer_name} | ‡πÄ‡∏ß‡∏•‡∏≤: {print_time} | ‡∏´‡∏ô‡πâ‡∏≤ " counter(page);
                    font-family: 'THSarabunNew';
                    font-size: 12pt;
                }}
            }}
            body {{
                font-family: 'THSarabunNew';
                font-size: 16pt;
                line-height: 1.2;
            }}
            .header {{
                text-align: center;
                position: relative;
                margin-bottom: 20px;
            }}
            .logo {{
                position: absolute;
                top: 0;
                left: 0;
                width: 60px;
            }}
            .qr {{
                position: absolute;
                top: 0;
                right: 0;
                width: 60px;
            }}
            .title {{
                font-size: 22pt;
                font-weight: bold;
            }}
            .subtitle {{
                font-size: 18pt;
                font-weight: bold;
            }}
            .info-table {{
                width: 100%;
                margin-bottom: 10px;
            }}
            .box {{
                border: 1px solid #000;
                background-color: #f9f9f9;
                padding: 10px;
                margin-bottom: 10px;
                min-height: 50px;
                word-wrap: break-word; /* ‡∏ï‡∏±‡∏î‡∏Ñ‡∏≥‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ */
            }}
            .signature-table {{
                width: 100%;
                margin-top: 30px;
                text-align: center;
                page-break-inside: avoid;
            }}
            .signature-table td {{
                padding-bottom: 30px;
                vertical-align: top;
            }}
        </style>
    </head>
    <body>
        <div class="header">
            {'<img class="logo" src="data:image/png;base64,' + LOGO_BASE64 + '">' if LOGO_BASE64 else ''}
            
            <div class="title">‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ‡∏ï‡∏≥‡∏£‡∏ß‡∏à‡∏†‡∏π‡∏ò‡∏£‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÇ‡∏û‡∏ô‡∏ó‡∏≠‡∏á‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤</div>
            <div class="subtitle">‡πÉ‡∏ö‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÅ‡∏•‡∏∞‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö‡∏™‡∏ß‡∏ô</div>
            
            <img class="qr" src="data:image/png;base64,{qr_base64}">
        </div>

        <hr>

        <table class="info-table">
            <tr>
                <td width="60%"><b>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡πÅ‡∏à‡πâ‡∏á:</b> {rid}</td>
                <td width="40%" style="text-align:right;"><b>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á:</b> {date_str}</td>
            </tr>
            <tr>
                <td colspan="2"><b>‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á:</b> {reporter}</td>
            </tr>
            <tr>
                <td><b>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏´‡∏ï‡∏∏:</b> {incident}</td>
                <td><b>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà:</b> {location}</td>
            </tr>
        </table>

        <div><b>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå:</b></div>
        <div class="box">
            {details}
        </div>

        <div><b>‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö‡∏™‡∏ß‡∏ô:</b></div>
        <div class="box">
            {statement}
        </div>

        {evidence_html}

        <table class="signature-table">
            <tr>
                <td width="50%">
                    ‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠..........................................................<br>
                    ( {row.get('Victim', '')} )<br>
                    ‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢
                </td>
                <td width="50%">
                    ‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠..........................................................<br>
                    ( {row.get('Accused', '')} )<br>
                    ‡∏ú‡∏π‡πâ‡∏ñ‡∏π‡∏Å‡∏Å‡∏•‡πà‡∏≤‡∏ß‡∏´‡∏≤
                </td>
            </tr>
            <tr>
                <td>
                    ‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠..........................................................<br>
                    ( {row.get('Student_Police_Investigator', '')} )<br>
                    ‡∏ï‡∏≥‡∏£‡∏ß‡∏à‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ö‡∏™‡∏ß‡∏ô
                </td>
                <td>
                    ‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠..........................................................<br>
                    ( {row.get('Witness', '')} )<br>
                    ‡∏û‡∏¢‡∏≤‡∏ô
                </td>
            </tr>
            <tr>
                <td colspan="2">
                    <br>
                    ‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠..........................................................<br>
                    ( {row.get('Teacher_Investigator', '')} )<br>
                    ‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ö‡∏™‡∏ß‡∏ô
                </td>
            </tr>
        </table>
    </body>
    </html>
    """
    
    # ‡∏™‡∏£‡πâ‡∏≤‡∏á PDF
    font_config = FontConfiguration()
    pdf_bytes = HTML(string=html_content, base_url=BASE_DIR).write_pdf(font_config=font_config)
    return pdf_bytes

# --- 3. ‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Database ‡πÅ‡∏•‡∏∞‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£) ---
def clean_val(val):
    if pd.isna(val) or str(val).lower() in ["nan", "none", ""] or val is None: return ""
    return str(val).strip()

def calculate_pagination(key, total_items, limit=5):
    if key not in st.session_state: st.session_state[key] = 1
    current_page = st.session_state[key]
    total_pages = math.ceil(total_items / limit)
    if total_pages == 0: total_pages = 1
    if current_page > total_pages: current_page = 1; st.session_state[key] = 1
    start_idx = (current_page - 1) * limit
    end_idx = start_idx + limit
    return start_idx, end_idx, current_page, total_pages

conn = st.connection("gsheets", type=GSheetsConnection)

# Helper Function
def view_case(rid):
    st.session_state.selected_case_id = rid
    st.session_state.view_mode = "detail"
    st.session_state.unlock_password = ""

def back_to_list():
    st.session_state.view_mode = "list"
    st.session_state.selected_case_id = None

def clear_search_callback():
    st.session_state.search_query = ""

# --- 4. Dashboard (‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏õ‡∏∏‡πà‡∏° Print) ---
def officer_dashboard():
    user = st.session_state.current_user
    col_h1, col_h2 = st.columns([4, 1])
    with col_h1: st.markdown(f"<div style='font-size: 26px; font-weight: bold; color: #1E3A8A;'>üè¢ ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≠‡∏ö‡∏™‡∏ß‡∏ô ‡∏Ñ‡∏∏‡∏ì{user['name']}</div>", unsafe_allow_html=True)
    with col_h2: 
        if st.button("üî¥ Logout", use_container_width=True):
            st.session_state.current_user = None; st.rerun()

    try:
        df = conn.read(ttl="1m")
        df = df.fillna("")
        df['Report_ID'] = df['Report_ID'].astype(str).str.replace(r'\.0$', '', regex=True)

        if st.session_state.view_mode == "list":
            # ... (‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏° ‡πÑ‡∏°‡πà‡πÅ‡∏Å‡πâ) ...
            tab_list, tab_dash = st.tabs(["üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏", "üìä ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥"])
            with tab_list:
                c_search, c_btn_search, c_btn_clear = st.columns([3, 1, 1])
                with c_search:
                    search_q = st.text_input("‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤", placeholder="‡πÄ‡∏•‡∏Ç‡πÄ‡∏Ñ‡∏™, ‡∏ä‡∏∑‡πà‡∏≠, ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå...", key="search_query", label_visibility="collapsed")
                with c_btn_search: st.button("üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤", use_container_width=True)
                with c_btn_clear: st.button("‚ùå ‡∏•‡πâ‡∏≤‡∏á", on_click=clear_search_callback, use_container_width=True)
                
                filtered_df = df.copy()
                if search_q:
                    filtered_df = filtered_df[filtered_df.apply(lambda row: row.astype(str).str.contains(search_q, case=False).any(), axis=1)]
                
                df_pending = filtered_df[filtered_df['Status'].isin(["‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£", "‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£"])][::-1]
                df_finished = filtered_df[filtered_df['Status'] == "‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢"][::-1]

                # List Pending
                st.markdown("<h4 style='color:#1E3A8A; background-color:#f0f2f6; padding:10px; border-radius:5px;'>‚è≥ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</h4>", unsafe_allow_html=True)
                start_p, end_p, curr_p, tot_p = calculate_pagination('page_pending', len(df_pending), 5)
                # ... (Render list code omitted for brevity as requested not to change unrelated parts) ...
                # ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö ‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏ß‡∏≤‡∏á‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô render list ‡πÄ‡∏î‡∏¥‡∏°‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤
                c1, c2, c3, c4 = st.columns([2.5, 2, 3, 1.5])
                c1.markdown("**‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡πÅ‡∏à‡πâ‡∏á**"); c2.markdown("**‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤**"); c3.markdown("**‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏´‡∏ï‡∏∏**"); c4.markdown("**‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞**")
                st.markdown("<hr style='margin: 5px 0;'>", unsafe_allow_html=True)
                for index, row in df_pending.iloc[start_p:end_p].iterrows():
                    raw_rid = str(row.get('Report_ID', '')).strip()
                    cc1, cc2, cc3, cc4 = st.columns([2.5, 2, 3, 1.5])
                    with cc1: st.button(f"üìù {raw_rid}", key=f"p_{index}", use_container_width=True, on_click=view_case, args=(raw_rid,))
                    with cc2: st.write(row.get('Timestamp', '-'))
                    with cc3: st.write(row.get('Incident_Type', '-'))
                    with cc4: st.markdown(f"<span style='color:orange;font-weight:bold'>‚è≥ ‡∏£‡∏≠‡∏™‡∏≠‡∏ö‡∏™‡∏ß‡∏ô</span>", unsafe_allow_html=True)
                    st.markdown("<hr style='margin: 5px 0; opacity: 0.3;'>", unsafe_allow_html=True)
                
                if tot_p > 1:
                    cp1, cp2, cp3 = st.columns([1, 2, 1])
                    with cp1: 
                        if st.button("‚¨ÖÔ∏è ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö (‡∏£‡∏≠)", key="prev_p", disabled=(curr_p==1)): st.session_state.page_pending -= 1; st.rerun()
                    with cp2: st.markdown(f"<div style='text-align:center;'>‡∏´‡∏ô‡πâ‡∏≤ {curr_p} / {tot_p}</div>", unsafe_allow_html=True)
                    with cp3: 
                        if st.button("‡∏ñ‡∏±‡∏î‡πÑ‡∏õ (‡∏£‡∏≠) ‚û°Ô∏è", key="next_p", disabled=(curr_p==tot_p)): st.session_state.page_pending += 1; st.rerun()

                st.markdown("---")
                # List Finished
                st.markdown("<h4 style='color:#2e7d32; background-color:#e8f5e9; padding:10px; border-radius:5px;'>‚úÖ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢</h4>", unsafe_allow_html=True)
                start_f, end_f, curr_f, tot_f = calculate_pagination('page_finished', len(df_finished), 5)
                # ... (Render list code same logic) ...
                c1, c2, c3, c4 = st.columns([2.5, 2, 3, 1.5])
                c1.markdown("**‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡πÅ‡∏à‡πâ‡∏á**"); c2.markdown("**‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤**"); c3.markdown("**‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏´‡∏ï‡∏∏**"); c4.markdown("**‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞**")
                st.markdown("<hr style='margin: 5px 0;'>", unsafe_allow_html=True)
                for index, row in df_finished.iloc[start_f:end_f].iterrows():
                    raw_rid = str(row.get('Report_ID', '')).strip()
                    cc1, cc2, cc3, cc4 = st.columns([2.5, 2, 3, 1.5])
                    with cc1: st.button(f"‚úÖ {raw_rid}", key=f"f_{index}", use_container_width=True, on_click=view_case, args=(raw_rid,))
                    with cc2: st.write(row.get('Timestamp', '-'))
                    with cc3: st.write(row.get('Incident_Type', '-'))
                    with cc4: st.markdown(f"<span style='color:green;font-weight:bold'>‚úÖ ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢</span>", unsafe_allow_html=True)
                    st.markdown("<hr style='margin: 5px 0; opacity: 0.3;'>", unsafe_allow_html=True)

            with tab_dash:
                st.info("‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥ (‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°)")

        elif st.session_state.view_mode == "detail":
            sid = st.session_state.selected_case_id
            sel = df[df['Report_ID'] == sid]
            if not sel.empty:
                idx = sel.index[0]
                row = sel.iloc[0]
                st.button("‚¨ÖÔ∏è ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£", on_click=back_to_list)
                
                # ... (‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°) ...
                with st.container(border=True):
                    st.markdown(f"### üìù ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡πÅ‡∏à‡πâ‡∏á: {sid}")
                    # ... (Input fields ‡∏ï‡πà‡∏≤‡∏á‡πÜ ‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°) ...
                    c1, c2 = st.columns(2)
                    with c1:
                        v_vic = st.text_input("‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢", value=clean_val(row.get('Victim')))
                        v_wit = st.text_input("‡∏û‡∏¢‡∏≤‡∏ô", value=clean_val(row.get('Witness')))
                        v_stu = st.text_input("‡∏ï‡∏≥‡∏£‡∏ß‡∏à‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô", value=clean_val(row.get('Student_Police_Investigator')))
                    with c2:
                        v_acc = st.text_input("‡∏ú‡∏π‡πâ‡∏ñ‡∏π‡∏Å‡∏Å‡∏•‡πà‡∏≤‡∏ß‡∏´‡∏≤", value=clean_val(row.get('Accused')))
                        v_tea = st.text_input("‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ö‡∏™‡∏ß‡∏ô", value=clean_val(row.get('Teacher_Investigator')))
                    
                    v_stmt = st.text_area("‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö‡∏™‡∏ß‡∏ô", value=clean_val(row.get('Statement')))
                    v_sta = st.selectbox("‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞", ["‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£", "‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢", "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å"], index=0) # ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á

                    if st.button("üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"):
                        # Save logic ...
                        df.at[idx, 'Victim'] = v_vic
                        df.at[idx, 'Accused'] = v_acc
                        df.at[idx, 'Witness'] = v_wit
                        df.at[idx, 'Teacher_Investigator'] = v_tea
                        df.at[idx, 'Student_Police_Investigator'] = v_stu
                        df.at[idx, 'Statement'] = v_stmt
                        df.at[idx, 'Status'] = v_sta
                        conn.update(data=df)
                        st.success("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à")
                        st.rerun()

                    # --- ‡∏™‡πà‡∏ß‡∏ô‡∏õ‡∏∏‡πà‡∏° PDF ‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡∏°‡πà ---
                    st.markdown("---")
                    with st.container(border=True):
                        st.markdown("#### üñ®Ô∏è ‡πÄ‡∏°‡∏ô‡∏π‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô")
                        col_pdf_1, col_pdf_2 = st.columns([3, 1])
                        with col_pdf_1:
                            st.caption("‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô PDF ‡∏â‡∏ö‡∏±‡∏ö‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå (‡∏ï‡∏±‡∏î‡∏Ñ‡∏≥‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á)")
                        with col_pdf_2:
                            try:
                                pdf_bytes = create_pdf(row)
                                st.download_button(
                                    label="‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î PDF",
                                    data=pdf_bytes,
                                    file_name=f"Report_{sid}.pdf",
                                    mime="application/pdf",
                                    type="primary",
                                    use_container_width=True
                                )
                            except Exception as e:
                                st.error(f"‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á PDF: {e}")
                                if "pango" in str(e).lower():
                                    st.error("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÑ‡∏ü‡∏•‡πå packages.txt ‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ 'pango' ‡πÅ‡∏•‡πâ‡∏ß")

    except Exception as e: st.error(f"Error: {e}")

# --- 5. ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ---
def main_page():
    if LOGO_PATH: st.image(LOGO_PATH, width=100)
    st.title("üëÆ‚Äç‚ôÇÔ∏è ‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ‡∏ï‡∏≥‡∏£‡∏ß‡∏à‡∏†‡∏π‡∏ò‡∏£‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô")
    # ... (‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°) ...
    st.info("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà")
    with st.expander("üîê ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà"):
        pw = st.text_input("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô", type="password")
        if st.button("Login"):
            accounts = st.secrets.get("officer_accounts", {})
            if pw in accounts:
                st.session_state.current_user = accounts[pw]
                st.rerun()
            else: st.error("‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏¥‡∏î")

# --- Run ---
if 'current_user' not in st.session_state: st.session_state.current_user = None
if 'view_mode' not in st.session_state: st.session_state.view_mode = "list"
if 'page_pending' not in st.session_state: st.session_state.page_pending = 1
if 'page_finished' not in st.session_state: st.session_state.page_finished = 1

if st.session_state.current_user: officer_dashboard()
else: main_page()
