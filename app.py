import streamlit as st
from streamlit_gsheets import GSheetsConnection
import pandas as pd
from datetime import datetime, timedelta
import pytz
import random
import os
from fpdf import FPDF

# --- 1. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÅ‡∏•‡∏∞‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ß‡∏•‡∏≤ ---
st.set_page_config(page_title="‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≤‡∏£‡∏ß‡∏±‡∏ï‡∏£‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô", page_icon="üëÆ‚Äç‚ôÇÔ∏è", layout="wide")

def get_now_th():
    return datetime.now(pytz.timezone('Asia/Bangkok'))

# ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏® Session State ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô Error
if 'current_user' not in st.session_state:
    st.session_state.current_user = None
if 'submitted_id' not in st.session_state:
    st.session_state.submitted_id = None
if 'last_activity' not in st.session_state:
    st.session_state.last_activity = get_now_th()

st.markdown("""
    <style>
    #MainMenu {visibility: hidden;} header {visibility: hidden;} footer {visibility: hidden;}
    .stDeployButton {display:none;} [data-testid="stSidebar"] {display: none;}
    .main-header { font-size: 26px; font-weight: bold; color: #1E3A8A; }
    .report-id-box { background-color: #f0f9ff; border: 2px solid #1E3A8A; padding: 20px; border-radius: 10px; text-align: center; margin: 20px 0; }
    </style>
""", unsafe_allow_html=True)

conn = st.connection("gsheets", type=GSheetsConnection)

def clean_val(val):
    if pd.isna(val) or str(val).lower() == "nan" or str(val) == "":
        return ""
    return str(val)

# --- üîë 2. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå ---
OFFICER_ACCOUNTS = {
    "Patwit1510": {"name": "‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î", "role": "admin"},
    "Pencharee001": {"name": "‡∏Ñ‡∏£‡∏π‡πÄ‡∏û‡πá‡∏ç‡∏ä‡∏£‡∏µ‡∏¢‡πå (‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á)", "role": "admin"},
    "Chaiya001": {"name": "‡∏Ñ‡∏£‡∏π‡πÑ‡∏ä‡∏¢‡∏≤(‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á)", "role": "admin"},
    "Jak001": {"name": "‡∏¢‡∏≤‡∏°‡∏à‡∏±‡∏Å‡∏£ (‡∏£‡∏õ‡∏†.)", "role": "admin"},
    "User01": {"name": "‡∏ú‡∏π‡πâ‡∏Å‡∏≥‡∏Å‡∏±‡∏ö(‡∏ï‡∏≥‡∏£‡∏ß‡∏à‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô)", "role": "admin"},
    "User02": {"name": "‡∏£‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏à‡∏£‡∏≤‡∏à‡∏£(‡∏ï‡∏≥‡∏£‡∏ß‡∏à‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô)", "role": "admin"},
    "User03": {"name": "‡∏Ñ‡∏£‡∏π‡πÄ‡∏ß‡∏£ (‡∏ï‡∏£‡∏ß‡∏à‡∏Å‡∏≤‡∏£‡∏ì‡πå)", "role": "viewer"},
    "User04": {"name": "‡∏ï‡∏≥‡∏£‡∏ß‡∏à‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô", "role": "viewer"}
}

if st.session_state.current_user:
    elapsed = (get_now_th() - st.session_state.last_activity).total_seconds()
    if elapsed > 1800: # 30 ‡∏ô‡∏≤‡∏ó‡∏µ
        st.session_state.current_user = None
        st.rerun()
    else:
        st.session_state.last_activity = get_now_th()

# --- üìÑ 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á PDF (‡∏ä‡πà‡∏≠‡∏á‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠ 5 ‡∏ù‡πà‡∏≤‡∏¢ + Footer) ---
def create_pdf(row_data):
    try:
        pdf = FPDF()
        pdf.set_margins(15, 15, 15)
        pdf.add_page()
        font_p = "THSarabunNew.ttf"
        logo_p = "school_logo.png"
        
        if not os.path.exists(font_p): return "MISSING_FONT"
        pdf.add_font('ThaiFont', '', font_p)
        if os.path.exists(logo_p): pdf.image(logo_p, x=15, y=12, w=18)
        
        pdf.set_y(15)
        pdf.set_font('ThaiFont', '', 20)
        pdf.cell(0, 10, txt="‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ‡∏ï‡∏≥‡∏£‡∏ß‡∏à‡∏†‡∏π‡∏ò‡∏£‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÇ‡∏û‡∏ô‡∏ó‡∏≠‡∏á‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤", ln=True, align='C')
        pdf.set_font('ThaiFont', '', 16)
        pdf.cell(0, 10, txt="‡πÉ‡∏ö‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÅ‡∏•‡∏∞‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö‡∏™‡∏ß‡∏ô", ln=True, align='C')
        pdf.ln(5)
        pdf.line(15, pdf.get_y(), 195, pdf.get_y())
        pdf.ln(8)

        pdf.set_font('ThaiFont', '', 14)
        pdf.cell(90, 8, txt=f"‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡πÅ‡∏à‡πâ‡∏á: {row_data.get('Report_ID', '-')}")
        pdf.cell(90, 8, txt=f"‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏: {row_data.get('Timestamp', '-')}", align='R', ln=True)
        pdf.multi_cell(0, 8, txt=f"‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏´‡∏ï‡∏∏: {row_data.get('Incident_Type', '-')} | ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà: {row_data.get('Location', '-')}")
        pdf.ln(10)

        # ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠ 5 ‡∏ù‡πà‡∏≤‡∏¢
        pdf.set_font('ThaiFont', '', 14)
        # ‡πÅ‡∏ñ‡∏ß 1
        pdf.cell(90, 8, txt="‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠.........................................", align='C')
        pdf.cell(90, 8, txt="‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠.........................................", ln=True, align='C')
        pdf.cell(90, 8, txt=f"( {clean_val(row_data.get('Victim'))} )", align='C')
        pdf.cell(90, 8, txt=f"( {clean_val(row_data.get('Accused'))} )", ln=True, align='C')
        pdf.cell(90, 8, txt="‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢", align='C')
        pdf.cell(90, 8, txt="‡∏ú‡∏π‡πâ‡∏ñ‡∏π‡∏Å‡∏Å‡∏•‡πà‡∏≤‡∏ß‡∏´‡∏≤", ln=True, align='C')
        pdf.ln(5)
        # ‡πÅ‡∏ñ‡∏ß 2
        pdf.cell(90, 8, txt="‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠.........................................", align='C')
        pdf.cell(90, 8, txt="‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠.........................................", ln=True, align='C')
        pdf.cell(90, 8, txt=f"( {clean_val(row_data.get('Student_Police_Investigator'))} )", align='C')
        pdf.cell(90, 8, txt=f"( {clean_val(row_data.get('Witness'))} )", ln=True, align='C')
        pdf.cell(90, 8, txt="‡∏ï‡∏≥‡∏£‡∏ß‡∏à‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ö‡∏™‡∏ß‡∏ô", align='C')
        pdf.cell(90, 8, txt="‡∏û‡∏¢‡∏≤‡∏ô", ln=True, align='C')
        pdf.ln(5)
        # ‡πÅ‡∏ñ‡∏ß 3
        pdf.cell(0, 8, txt="‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠..........................................................", ln=True, align='C')
        pdf.cell(0, 8, txt=f"( {clean_val(row_data.get('Teacher_Investigator'))} )", ln=True, align='C')
        pdf.cell(0, 8, txt="‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ö‡∏™‡∏ß‡∏ô / ‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á", ln=True, align='C')

        # Footer
        pdf.set_y(-20)
        pdf.set_font('ThaiFont', '', 10)
        pdf.cell(0, 5, txt=f"‡∏û‡∏¥‡∏°‡∏û‡πå‡πÇ‡∏î‡∏¢: {st.session_state.current_user['name']} | ‡πÄ‡∏ß‡∏•‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå: {get_now_th().strftime('%d/%m/%Y %H:%M:%S')}", align='R')

        return pdf.output()
    except Exception as e: return str(e)

# --- üìã 4. ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ Dashboard ‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà ---
def officer_dashboard():
    user = st.session_state.current_user
    logo_p = "school_logo.png"
    if os.path.exists(logo_p):
        c1, c2, c3 = st.columns([5, 1, 5])
        with c2: st.image(logo_p, width=80)

    col_h1, col_h2 = st.columns([4, 1])
    with col_h1: st.markdown(f"<div class='main-header'>üè¢ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ (‡∏Ñ‡∏∏‡∏ì{user['name']})</div>", unsafe_allow_html=True)
    with col_h2: 
        if st.button("üî¥ Logout", use_container_width=True):
            st.session_state.current_user = None
            st.rerun()

    try:
        df = conn.read(ttl=0)
        tab1, tab2 = st.tabs(["üîé ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î", "üõ† ‡∏™‡∏≠‡∏ö‡∏™‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•"])
        
        with tab1:
            # ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á: ‡πÄ‡∏•‡∏Ç‡πÄ‡∏Ñ‡∏™‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ ‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç
            display_df = df[['Report_ID', 'Timestamp', 'Incident_Type', 'Location', 'Status']].copy()
            display_df.columns = ['‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡πÅ‡∏à‡πâ‡∏á', '‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á', '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏´‡∏ï‡∏∏', '‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà', '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô']
            st.dataframe(display_df.iloc[::-1], use_container_width=True)

        with tab2:
            ids = df['Report_ID'].dropna().unique().tolist()
            sid = st.selectbox("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î/‡∏™‡∏≠‡∏ö‡∏™‡∏ß‡∏ô", ids)
            sel = df[df['Report_ID'] == sid]
            
            if not sel.empty:
                idx = sel.index[0]
                row = sel.iloc[0]
                is_admin = user['role'] == 'admin' # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô
                
                with st.container(border=True):
                    st.subheader(f"üî¢ ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡πÅ‡∏à‡πâ‡∏á: {sid}")
                    st.write(f"üö© **‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á:** {row['Reporter']} | **‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏´‡∏ï‡∏∏:** {row['Incident_Type']}")
                    st.write(f"üìù **‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå:** {row['Details']}")
                    st.markdown("---")
                    
                    st.write("üìã **‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö‡∏™‡∏ß‡∏ô**")
                    c1, c2 = st.columns(2)
                    with c1:
                        v_vic = st.text_input("‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢", value=clean_val(row.get('Victim')), disabled=not is_admin)
                        v_acc = st.text_input("‡∏ú‡∏π‡πâ‡∏ñ‡∏π‡∏Å‡∏Å‡∏•‡πà‡∏≤‡∏ß‡∏´‡∏≤", value=clean_val(row.get('Accused')), disabled=not is_admin)
                        v_wit = st.text_input("‡∏û‡∏¢‡∏≤‡∏ô", value=clean_val(row.get('Witness')), disabled=not is_admin)
                    with c2:
                        v_tea = st.text_input("‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ö‡∏™‡∏ß‡∏ô", value=clean_val(row.get('Teacher_Investigator')), disabled=not is_admin)
                        v_stu = st.text_input("‡∏ï‡∏≥‡∏£‡∏ß‡∏à‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏≠‡∏ö‡∏™‡∏ß‡∏ô", value=clean_val(row.get('Student_Police_Investigator')), disabled=not is_admin)
                        st_opts = ["‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£", "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£", "‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß", "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å"]
                        v_sta = st.selectbox("‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞", st_opts, index=st_opts.index(row['Status']) if row['Status'] in st_opts else 0, disabled=not is_admin)
                    
                    v_stmt = st.text_area("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡πÉ‡∏´‡πâ‡∏Å‡∏≤‡∏£/‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£", value=clean_val(row.get('Statement')), disabled=not is_admin)

                    if is_admin:
                        if st.button("üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö‡∏™‡∏ß‡∏ô", type="primary", use_container_width=True):
                            df.at[idx, 'Victim'], df.at[idx, 'Accused'], df.at[idx, 'Witness'] = v_vic, v_acc, v_wit
                            df.at[idx, 'Teacher_Investigator'], df.at[idx, 'Student_Police_Investigator'] = v_tea, v_stu
                            df.at[idx, 'Status'], df.at[idx, 'Statement'], df.at[idx, 'Handled_By'] = v_sta, v_stmt, user['name']
                            conn.update(data=df)
                            st.success("‚úÖ ‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!") # ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
                            st.rerun()
                    else:
                        st.info("üîí ‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡∏£‡∏∑‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ")
                    
                    pdf_bytes = create_pdf(df.loc[idx])
                    if isinstance(pdf_bytes, (bytes, bytearray)):
                        st.download_button("üì• ‡∏û‡∏¥‡∏°‡∏û‡πå PDF ‡πÉ‡∏ö‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏™‡∏≠‡∏ö‡∏™‡∏ß‡∏ô", data=bytes(pdf_bytes), file_name=f"Report_{sid}.pdf", mime="application/pdf", use_container_width=True)
    except Exception as e: st.error(f"Error: {e}")

# --- üìù 5. ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏´‡∏•‡∏±‡∏Å (‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏) ---
def main_page():
    logo_p = "school_logo.png"
    if os.path.exists(logo_p):
        c1, c2, c3 = st.columns([5, 1, 5])
        with c2: st.image(logo_p, width=100)

    st.markdown("<h1 style='text-align: center; color: #1E3A8A;'>üëÆ‚Äç‚ôÇÔ∏è ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡∏™‡∏≤‡∏£‡∏ß‡∏±‡∏ï‡∏£‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h1>", unsafe_allow_html=True)
    
    if st.session_state.submitted_id:
        st.markdown(f"<div class='report-id-box'><h2>‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</h2><p>‡πÄ‡∏•‡∏Ç‡∏£‡∏±‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠: <b>{st.session_state.submitted_id}</b></p></div>", unsafe_allow_html=True)
        if st.button("‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà"):
            st.session_state.submitted_id = None
            st.rerun()
    else:
        with st.form("report"):
            c1, c2 = st.columns(2)
            with c1:
                rep = st.text_input("‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á")
                typ = st.selectbox("‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏´‡∏ï‡∏∏", ["‡∏ó‡∏∞‡πÄ‡∏•‡∏≤‡∏∞‡∏ß‡∏¥‡∏ß‡∏≤‡∏ó", "‡∏™‡∏≤‡∏£‡πÄ‡∏™‡∏û‡∏ï‡∏¥‡∏î", "‡∏ä‡∏π‡πâ‡∏™‡∏≤‡∏ß", "‡∏´‡∏ô‡∏µ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô", "‡∏≠‡∏∑‡πà‡∏ô‡πÜ"])
            with c2: loc = st.text_input("‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡πÄ‡∏´‡∏ï‡∏∏ *")
            det = st.text_area("‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå *")
            if st.form_submit_button("üì§ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏", use_container_width=True):
                if loc and det:
                    rid = f"POL-{get_now_th().strftime('%Y%m%d')}-{random.randint(1000, 9999)}"
                    df_old = conn.read(ttl=0)
                    new_r = pd.DataFrame([{"Timestamp": get_now_th().strftime("%d/%m/%Y %H:%M:%S"), "Reporter": rep, "Incident_Type": typ, "Location": loc, "Details": det, "Status": "‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£", "Report_ID": rid}])
                    conn.update(data=pd.concat([df_old, new_r], ignore_index=True))
                    st.session_state.submitted_id = rid
                    st.rerun()
                else: st.error("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö")

    st.markdown("---")
    with st.expander("üîê ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà"):
        pw = st.text_input("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô", type="password")
        if st.button("‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö"):
            if pw in OFFICER_ACCOUNTS:
                st.session_state.current_user = OFFICER_ACCOUNTS[pw]
                st.session_state.last_activity = get_now_th()
                st.rerun()
            else: st.error("‚ùå ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á")

# --- üöÄ 6. ‡∏£‡∏±‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ---
if st.session_state.current_user:
    officer_dashboard()
else:
    main_page()
